#!/usr/bin/env python3

# Ligand TasarÄ±mÄ± ve Docking Pipeline (REINVENT4 + AutoDock Vina)

# Bu betik, bir protein cebine Ã¶zgÃ¼ ligand tasarlamak, ADMET Ã¶zelliklerini ve docking skorlarÄ±nÄ± hesaplamak, ardÄ±ndan en uygun 2 adayÄ± seÃ§mek iÃ§in tam bir otomatik akÄ±ÅŸ (pipeline) saÄŸlar.

# Yazan: Duygu Ä°rem 
# Tarih: 2025

# ===============================================================
# ğŸ§© 0. GEREKLÄ° KÃœTÃœPHANELER VE AYARLAR
# ===============================================================
import os, sys, subprocess
import numpy as np
from rdkit import Chem
from rdkit.Chem import Descriptors, QED, rdMolDescriptors, AllChem, rdmolfiles
from rdkit.DataStructs import TanimotoSimilarity

# --- Opsiyonel: Synthetic Accessibility (SA) skoru ---
try:
    import sascorer
    have_sa = True
except ImportError:
    have_sa = False
    print("[UYARI] 'sascorer' modÃ¼lÃ¼ yÃ¼klenemedi, SA skorlarÄ± hesaplanmayacak.")

# --- REINVENT4 BileÅŸenleri ---
from reinvent_chemistry.conversions import SmilesConverter
from reinvent_models.model_factory import load_model
from reinvent_scoring.scoring_function import ScoringFunctionFactory

import torch

# ===============================================================
# âš™ï¸ 1. KULLANICI PARAMETRELERÄ°
# ===============================================================
VINA_PATH = "/usr/local/bin/vina"             # AutoDock Vina yÃ¼rÃ¼tÃ¼lebilir dosyasÄ±
PDB_FILE = "/path/to/your/pocket.pdb"         # Hedef protein cep dosyasÄ± (.pdb)
MODEL_PATH = "reinvent.prior"                 # REINVENT4 Ã¶nceden eÄŸitilmiÅŸ model yolu
NUM_LIGANDS = 200                             # Ãœretilecek ligand sayÄ±sÄ±
TOP_K = 2                                     # En iyi 2 ligand seÃ§ilecek
OUT_DIR = "top3_prepared"                     # Ã‡Ä±ktÄ± klasÃ¶rÃ¼
os.makedirs(OUT_DIR, exist_ok=True)


# ===============================================================
# ğŸ§  2. CEP ANALÄ°ZÄ°
# ===============================================================
def analyze_pocket(pdb_file):
# PDB cebini okur, geometrik merkezini ve boyutlarÄ±nÄ± belirler.

    if not os.path.exists(pdb_file):
        print("[HATA] PDB dosyasÄ± bulunamadÄ±:", pdb_file)
        return None

    mol = rdmolfiles.MolFromPDBFile(pdb_file, removeHs=False)
    if mol is None:
        print("[HATA] PDB okunamadÄ±, RDKit baÅŸarÄ±sÄ±z.")
        return None

    conf = mol.GetConformer()
    coords = np.array([list(conf.GetAtomPosition(i)) for i in range(mol.GetNumAtoms())])
    center = np.mean(coords, axis=0)
    size = np.std(coords, axis=0)

    print(f"[OK] Pocket center: {center}, size: {size}")
    return {'mol': mol, 'coords': coords, 'center': center, 'size': size}


# ===============================================================
# ğŸ¤– 3. REINVENT4 Ä°LE LÄ°GAND TASARIMI
# ===============================================================
def generate_ligands_reinvent(num_ligands):
# REINVENT4 Ã¶nceden eÄŸitilmiÅŸ 'prior' modeliyle molekÃ¼l Ã¶rnekler.
    
    print("[INFO] REINVENT4 modeli yÃ¼kleniyor...")
    device = "cuda" if torch.cuda.is_available() else "cpu"
    model = load_model(MODEL_PATH, device=device)

    scoring_function = ScoringFunctionFactory().from_config({"name": "QEDScore"})
    ligands = []
    generated = 0

    print(f"[INFO] {num_ligands} ligand Ã¶rnekleniyor...")

    while generated < num_ligands:
        try:
            smiles_list = model.sample_smiles(batch_size=8, scoring_function=scoring_function)
        except Exception as e:
            print("[HATA] Ligand Ã¼retimi sÄ±rasÄ±nda hata:", e)
            break

        for smi in smiles_list:
            mol = Chem.MolFromSmiles(smi)
            if mol is None:
                continue
            mol = Chem.AddHs(mol)
            AllChem.EmbedMolecule(mol, randomSeed=generated)
            AllChem.MMFFOptimizeMolecule(mol)
            ligands.append({'smiles': smi, 'mol': mol})
            generated += 1
            if generated >= num_ligands:
                break

    print(f"[OK] GeÃ§erli {len(ligands)} molekÃ¼l Ã¼retildi.")
    return ligands


# ===============================================================
# ğŸ§¬ 4. ADMET ve SA SKORLAMASI
# ===============================================================
def admet_score(mol):

# BasitleÅŸtirilmiÅŸ Lipinski ve TPSA temelli bir ADMET skoru Ã¼retir.
    
    lv = 0
    mw = Descriptors.MolWt(mol)
    logp = Descriptors.MolLogP(mol)
    hbd = rdMolDescriptors.CalcNumHBD(mol)
    hba = rdMolDescriptors.CalcNumHBA(mol)

    if mw > 500: lv += 1
    if logp > 5: lv += 1
    if hbd > 5: lv += 1
    if hba > 10: lv += 1
    lip_score = max(0.0, 1.0 - 0.25 * lv)

    tpsa = rdMolDescriptors.CalcTPSA(mol)
    tpsa_score = 1.0 if tpsa <= 140 else max(0.0, 1 - (tpsa - 140) / 200.0)
    logp_score = 1.0 if abs(logp) <= 5 else max(0.0, 1 - (abs(logp) - 5) / 5.0)

    score = 0.5 * lip_score + 0.3 * tpsa_score + 0.2 * logp_score
    return float(max(0.0, min(1.0, score)))


def sa_score(mol):

# Synthetic Accessibility skorunu hesaplar (1â€“10 arasÄ±). 
# DÃ¼ÅŸÃ¼k deÄŸerler sentez kolaylÄ±ÄŸÄ±nÄ± gÃ¶sterir.
    if not have_sa:
        return None
    try:
        return sascorer.calculateScore(mol)
    except Exception:
        return None


# ===============================================================
# ğŸ§« 5. DOCKING (AutoDock Vina)
# ===============================================================
def prepare_ligand_for_vina(mol, name_prefix):

# MolekÃ¼lÃ¼ .pdbqt formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r (OpenBabel Ã¼zerinden).

    pdbqt_file = os.path.join(OUT_DIR, f"{name_prefix}.pdbqt")
    mol_file = os.path.join(OUT_DIR, f"{name_prefix}.mol2")

    Chem.MolToMol2File(mol, mol_file)
    cmd = f"obabel {mol_file} -O {pdbqt_file} --partialcharge gasteiger -h"
    subprocess.run(cmd, shell=True, check=False)

    return pdbqt_file


def dock_ligand(mol, pocket, name_prefix):
  
# AutoDock Vina ile ligand-protein docking iÅŸlemini yÃ¼rÃ¼tÃ¼r.
    
    pdbqt_file = prepare_ligand_for_vina(mol, name_prefix)
    out_log = os.path.join(OUT_DIR, f"{name_prefix}_vina_out.txt")
    out_pdbqt = os.path.join(OUT_DIR, f"{name_prefix}_vina_out.pdbqt")

    x, y, z = pocket['center']
    size_x, size_y, size_z = np.clip(pocket['size'] * 2, 10.0, 30.0)

    cmd = (
        f"{VINA_PATH} --receptor {PDB_FILE} --ligand {pdbqt_file} "
        f"--center_x {x:.3f} --center_y {y:.3f} --center_z {z:.3f} "
        f"--size_x {size_x:.3f} --size_y {size_y:.3f} --size_z {size_z:.3f} "
        f"--out {out_pdbqt} --log {out_log}"
    )

    result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
    if result.returncode != 0:
        print("[UYARI] Docking baÅŸarÄ±sÄ±z:", result.stderr)
        return -10.0

    score = -10.0
    with open(out_log, "r") as f:
        for line in f:
            if line.strip().startswith("REMARK VINA RESULT:"):
                try:
                    score = float(line.strip().split()[3])
                    break
                except Exception:
                    pass
    return score


# ===============================================================
# ğŸ§® 6. SKORLAMA ve EN Ä°YÄ° 2 SEÃ‡Ä°MÄ°
# ===============================================================

from rdkit.Chem import AllChem
from rdkit.DataStructs import TanimotoSimilarity

def calculate_combined(ligand):
  
# Docking, ADMET, QED ve SA skorlarÄ±nÄ± aÄŸÄ±rlÄ±klÄ± olarak birleÅŸtirir.

    w_d, w_a, w_q, w_s = 0.5, 0.25, 0.2, 0.05
    sa_norm = 0.5 if ligand.get('sa') is None else (1.0 - ligand['sa'] / 10.0)

    ligand['combined'] = (
        w_d * ligand['dock_score'] +
        w_a * ligand['admet'] +
        w_q * ligand['qed'] +
        w_s * sa_norm
    )


def select_top(ligands, k=2):
  
# En yÃ¼ksek birleÅŸik skora sahip ve birbirinden farklÄ± (Ã§eÅŸitli) k adet ligand seÃ§er.
# VarsayÄ±lan: k=2

    if not ligands:
        return []

    # Skor sÄ±ralamasÄ±
    ligands.sort(key=lambda x: x['combined'], reverse=True)
    fps = [AllChem.GetMorganFingerprintAsBitVect(l['mol'], 2, 2048) for l in ligands]

    selected = [0]  # Ä°lk olarak en yÃ¼ksek skorlu molekÃ¼l seÃ§ilir
    while len(selected) < k and len(selected) < len(ligands):
        best_idx, best_min_dist = None, -1
        for i, fp in enumerate(fps):
            if i in selected:
                continue
            sims = [TanimotoSimilarity(fp, fps[s]) for s in selected]
            min_dist = 1.0 - max(sims)
            if min_dist > best_min_dist:
                best_min_dist = min_dist
                best_idx = i
        if best_idx is None:
            break
        selected.append(best_idx)

    return [ligands[i] for i in selected]

# ===============================================================
# ğŸš€ 7. ANA PIPELINE
# ===============================================================
def main():
    print("==== Ligand TasarÄ±mÄ± ve Docking BaÅŸlatÄ±lÄ±yor ====")
    pocket = analyze_pocket(PDB_FILE)
    if pocket is None:
        return

    ligands = generate_ligands_reinvent(NUM_LIGANDS)

    for l in ligands:
        l['qed'] = QED.qed(l['mol'])
        l['admet'] = admet_score(l['mol'])
        l['sa'] = sa_score(l['mol'])
        l['dock_score'] = dock_ligand(l['mol'], pocket, l['smiles'])
        calculate_combined(l)

    top3 = select_top3(ligands)

    # --- Ã‡Ä±ktÄ±lar ---
    out_txt = "top2_smiles.txt"
    out_sdf = "top2.sdf"
    writer = rdmolfiles.SDWriter(out_sdf)
    with open(out_txt, "w") as f:
        for l in top3:
            writer.write(l['mol'])
            f.write(f"{l['smiles']}\tCombined={l['combined']:.4f}\tDock={l['dock_score']:.2f}\tQED={l['qed']:.3f}\tADMET={l['admet']:.3f}\tSA={l['sa']}\n")
    writer.close()

    print(f"[OK] En iyi 2 ligand kaydedildi: {out_txt}, {out_sdf}")
    for l in top3:
        print(l['smiles'], "Combined=", l['combined'], "Dock=", l['dock_score'], "QED=", l['qed'], "ADMET=", l['admet'], "SA=", l['sa'])


# ===============================================================
# ğŸ§© Ã‡ALIÅTIRMA NOKTASI
# ===============================================================
if __name__ == "__main__":
    main()

