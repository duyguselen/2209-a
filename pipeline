#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
FULL PIPELINE: Pocket-specific ligand generation with REINVENT + ADMET + Docking
Author: Duygu Ä°rem Ã–zger
Description:
 - KullanÄ±cÄ± tarafÄ±ndan verilen pocket PDB'den merkez ve boyut hesaplanÄ±r
 - REINVENT pretrained modeliyle ligand Ã¼retimi yapÄ±lÄ±r
 - Lipinski kurallarÄ±na gÃ¶re filtreleme
 - Docking (AutoDock Vina)
 - QED + ADMET skorlamasÄ±
 - En iyi 2 ligand seÃ§ilir, SDF + PNG olarak kaydedilir
"""

import os
import subprocess
import numpy as np
from rdkit import Chem
from rdkit.Chem import AllChem, Descriptors, QED, Draw, rdMolDescriptors, rdmolfiles
from multiprocessing import Pool
from reinvent import load_model
from reinvent.models.scoring import ScoringFunctionFactory

# =====================
# 0. KullanÄ±cÄ± AyarlarÄ±
# =====================
PDB_FILE = "my_pocket.pdb"               # Pocket dosyanÄ± buraya koy
VINA_PATH = "/usr/local/bin/vina"        # Vina yolu
OUT_DIR = "top2_results"
MODEL_PATH = "reinvent_model.pt"         # HazÄ±r REINVENT modeli
NUM_LIGANDS = 20                         # Ãœretilecek ligand sayÄ±sÄ±
N_CPU = 4                                # Paralel Ã§ekirdek sayÄ±sÄ±

os.makedirs(OUT_DIR, exist_ok=True)

# =====================
# 1. Pocket Analizi
# =====================
def analyze_pocket(pdb_file):
    """Pocket merkez ve boyutlarÄ±nÄ± PDB dosyasÄ±ndan hesaplar."""
    mol = rdmolfiles.MolFromPDBFile(pdb_file, removeHs=False)
    if mol is None:
        raise ValueError(f"âŒ Pocket dosyasÄ± okunamadÄ±: {pdb_file}")
    conf = mol.GetConformer()
    coords = np.array([list(conf.GetAtomPosition(i)) for i in range(mol.GetNumAtoms())])
    center = np.mean(coords, axis=0)
    size = np.std(coords, axis=0)
    print(f"ðŸ“¦ Pocket center = {center}, size = {size*2}")
    return {'mol': mol, 'center': center, 'size': size}

# =====================
# 2. Ligand Ãœretimi
# =====================
def generate_ligands_reinvent(num_ligands):
    print("ðŸ”¹ REINVENT modeli yÃ¼kleniyor...")
    model = load_model(MODEL_PATH)
    scoring_function = ScoringFunctionFactory().from_config({"name": "QEDScore"})
    
    ligands = []
    for i in range(num_ligands):
        smi = model.sample(scoring_function=scoring_function)
        mol = Chem.MolFromSmiles(smi)
        if mol is None:
            continue
        mol = Chem.AddHs(mol)
        AllChem.EmbedMolecule(mol, randomSeed=i)
        AllChem.MMFFOptimizeMolecule(mol)
        ligands.append({'smiles': smi, 'mol': mol})
    print(f"ðŸ§¬ {len(ligands)} ligand Ã¼retildi.")
    return ligands

# =====================
# 3. Lipinski Filtresi
# =====================
def lipinski_violations(mol):
    mw = Descriptors.MolWt(mol)
    logp = Descriptors.MolLogP(mol)
    hbd = rdMolDescriptors.CalcNumHBD(mol)
    hba = rdMolDescriptors.CalcNumHBA(mol)
    v = 0
    if mw > 500: v += 1
    if logp > 5: v += 1
    if hbd > 5: v += 1
    if hba > 10: v += 1
    return v

# =====================
# 4. Ligand HazÄ±rlÄ±ÄŸÄ± (Vina)
# =====================
def prepare_ligand_for_vina(mol, name_prefix):
    pdbqt_file = os.path.join(OUT_DIR, f"{name_prefix}.pdbqt")
    mol_file = os.path.join(OUT_DIR, f"{name_prefix}.mol2")
    Chem.MolToMol2File(mol, mol_file)
    cmd = f"obabel {mol_file} -O {pdbqt_file} -xp"
    subprocess.run(cmd, shell=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    return pdbqt_file

# =====================
# 5. Docking
# =====================
def dock_ligand(args):
    i, ligand, pocket = args
    name_prefix = f"lig_{i}"
    pdbqt_file = prepare_ligand_for_vina(ligand['mol'], name_prefix)
    out_log = os.path.join(OUT_DIR, f"{name_prefix}_vina_out.txt")
    out_pdbqt = os.path.join(OUT_DIR, f"{name_prefix}_vina_out.pdbqt")

    x, y, z = pocket['center']
    size_x, size_y, size_z = pocket['size'] * 2

    cmd = (
        f"{VINA_PATH} --receptor {PDB_FILE} --ligand {pdbqt_file} "
        f"--center_x {x:.3f} --center_y {y:.3f} --center_z {z:.3f} "
        f"--size_x {size_x:.3f} --size_y {size_y:.3f} --size_z {size_z:.3f} "
        f"--out {out_pdbqt} --log {out_log}"
    )
    subprocess.run(cmd, shell=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

    score = 999.0
    with open(out_log, "r") as f:
        for line in f:
            if line.strip().startswith("REMARK VINA RESULT:"):
                try:
                    score = float(line.strip().split()[3])
                    break
                except:
                    pass
    return (i, score)

# =====================
# 6. ADMET Skoru
# =====================
def calc_admet_score(mol):
    logp = Descriptors.MolLogP(mol)
    qed = QED.qed(mol)
    score = (qed + (1 - abs(logp - 2.5)/5)) / 2
    return max(0.0, min(1.0, score))

# =====================
# 7. Ana AkÄ±ÅŸ
# =====================
def main():
    print("ðŸš€ Pipeline baÅŸlatÄ±lÄ±yor...")
    pocket = analyze_pocket(PDB_FILE)

    ligands = generate_ligands_reinvent(NUM_LIGANDS)
    ligands = [l for l in ligands if lipinski_violations(l['mol']) <= 1]
    print(f"ðŸ§ª {len(ligands)} ligand Lipinski filtresinden geÃ§ti.")

    for l in ligands:
        l['qed'] = QED.qed(l['mol'])
        l['admet'] = calc_admet_score(l['mol'])

    print("âš™ï¸ Docking baÅŸlatÄ±lÄ±yor (paralel)...")
    with Pool(N_CPU) as pool:
        results = pool.map(dock_ligand, [(i, l, pocket) for i, l in enumerate(ligands)])
    for i, score in results:
        ligands[i]['dock_score'] = score

    for l in ligands:
        l['total'] = (l['qed']*0.3 + l['admet']*0.2) - (l['dock_score']/20.0)

    top2 = sorted(ligands, key=lambda x: x['total'], reverse=True)[:2]

    sdf_file = os.path.join(OUT_DIR, "top2.sdf")
    writer = Chem.SDWriter(sdf_file)
    for l in top2:
        writer.write(l['mol'])
    writer.close()

    img = Draw.MolsToGridImage(
        [l['mol'] for l in top2],
        molsPerRow=2,
        subImgSize=(400, 400),
        legends=[f"Dock={l['dock_score']:.2f}\nQED={l['qed']:.2f}\nADMET={l['admet']:.2f}" for l in top2]
    )
    img.save(os.path.join(OUT_DIR, "top2_ligands.png"))

    print("ðŸŽ¯ En iyi 2 ligand:")
    for i, l in enumerate(top2, 1):
        print(f"{i}. {l['smiles']} | Dock={l['dock_score']:.2f} | QED={l['qed']:.2f} | ADMET={l['admet']:.2f}")
    print("ðŸ“ SonuÃ§ klasÃ¶rÃ¼:", OUT_DIR)

# =====================
if __name__ == "__main__":
    main()
